name: Deploy n8n Workflows

on:
  push:
    branches: [main]
    paths:
      - 'workflows/**/*.json'

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      N8N_HOST: ${{ secrets.N8N_HOST }}
      N8N_API_KEY: ${{ secrets.N8N_API_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install jq (for JSON parsing)
        run: sudo apt-get install jq

      - name: Sync workflows to n8n
        run: |
          API_URL="https://${N8N_HOST}/api/v1"
          AUTH_HEADER="Authorization: Bearer ${N8N_API_KEY}"

          for file in $(find workflows -type f -name "*.json"); do
            echo "Processing $file..."
            WORKFLOW_NAME=$(jq -r '.name' "$file")

            # Check if the workflow already exists
            EXISTING=$(curl -s -H "$AUTH_HEADER" "$API_URL/workflows" | jq -r --arg NAME "$WORKFLOW_NAME" '.data[] | select(.name == $NAME) | .id')

            if [ -n "$EXISTING" ]; then
              echo "Updating existing workflow: $WORKFLOW_NAME (ID: $EXISTING)"
              curl -X PUT "$API_URL/workflows/$EXISTING" \
                -H "$AUTH_HEADER" \
                -H "Content-Type: application/json" \
                --data-binary @"$file"
            else
              echo "Creating new workflow: $WORKFLOW_NAME"
              curl -X POST "$API_URL/workflows" \
                -H "$AUTH_HEADER" \
                -H "Content-Type: application/json" \
                --data-binary @"$file"
            fi
          done
